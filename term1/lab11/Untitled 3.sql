PRINT N'=== СРАВНЕНИЕ СТАТИЧЕСКОГО И ДИНАМИЧЕСКОГО КУРСОРОВ ===';

DECLARE @тестовый_заказчик nvarchar(40);
SELECT TOP 1 @тестовый_заказчик = Заказчик FROM Заказы;
PRINT N'Будем использовать заказчика: ' + @тестовый_заказчик;

-- Исходное количество
DECLARE @исходное_количество int;
SELECT @исходное_количество = COUNT(*) FROM Заказы WHERE Заказчик = @тестовый_заказчик;
PRINT N'Исходное количество заказов: ' + CAST(@исходное_количество AS nvarchar(10));

-- Создаем курсоры С SCROLL для возможности возврата к началу
PRINT N'--- СОЗДАЕМ КУРСОРЫ ---';
DECLARE статический CURSOR LOCAL STATIC SCROLL FOR 
SELECT Номер_заказа FROM Заказы WHERE Заказчик = @тестовый_заказчик;

DECLARE динамический CURSOR LOCAL DYNAMIC SCROLL FOR 
SELECT Номер_заказа FROM Заказы WHERE Заказчик = @тестовый_заказчик;

-- Открываем курсоры
PRINT N'--- ОТКРЫВАЕМ КУРСОРЫ (до вставки) ---';
OPEN статический;
OPEN динамический;

-- Подсчет ДО вставки
DECLARE @статическое_до int = 0, @динамическое_до int = 0;
DECLARE @temp_номер nvarchar(20);

-- Считаем статический (и возвращаемся к началу)
FETCH FIRST FROM статический INTO @temp_номер;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @статическое_до = @статическое_до + 1;
    FETCH NEXT FROM статический INTO @temp_номер;
END;

-- Считаем динамический (и возвращаемся к началу)  
FETCH FIRST FROM динамический INTO @temp_номер;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @динамическое_до = @динамическое_до + 1;
    FETCH NEXT FROM динамический INTO @temp_номер;
END;

PRINT N'ДО вставки - Статический: ' + CAST(@статическое_до AS nvarchar(10)) + N' заказов';
PRINT N'ДО вставки - Динамический: ' + CAST(@динамическое_до AS nvarchar(10)) + N' заказов';

-- ВСТАВКА НОВОГО ЗАКАЗА
PRINT N'--- ВСТАВКА НОВОГО ЗАКАЗА ---';
DECLARE @существующий_товар nvarchar(40);
SELECT TOP 1 @существующий_товар = Наименование FROM Товары;

INSERT INTO Заказы (Номер_заказа, Наименование_товара, Цена_продажи, Количество, Заказчик)
VALUES ('999', @существующий_товар, 100, 1, @тестовый_заказчик);

PRINT N'Новый заказ добавлен: ' + @существующий_товар;

-- ПОДСЧЕТ ПОСЛЕ ВСТАВКИ (возвращаемся к началу курсоров)
PRINT N'--- ПРОВЕРКА ПОСЛЕ ВСТАВКИ ---';
DECLARE @статическое_после int = 0, @динамическое_после int = 0;

-- Статический курсор (должен показать старые данные)
FETCH FIRST FROM статический INTO @temp_номер;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @статическое_после = @статическое_после + 1;
    FETCH NEXT FROM статический INTO @temp_номер;
END;

-- Динамический курсор (должен показать новые данные)
FETCH FIRST FROM динамический INTO @temp_номер;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @динамическое_после = @динамическое_после + 1;
    FETCH NEXT FROM динамический INTO @temp_номер;
END;

PRINT N'ПОСЛЕ вставки - Статический: ' + CAST(@статическое_после AS nvarchar(10)) + N' заказов';
PRINT N'ПОСЛЕ вставки - Динамический: ' + CAST(@динамическое_после AS nvarchar(10)) + N' заказов';

-- Фактическое количество в таблице
DECLARE @фактическое_количество int;
SELECT @фактическое_количество = COUNT(*) FROM Заказы WHERE Заказчик = @тестовый_заказчик;
PRINT N'Фактическое количество в таблице: ' + CAST(@фактическое_количество AS nvarchar(10)) + N' заказов';

-- Закрываем курсоры
CLOSE статический;
CLOSE динамический;
DEALLOCATE статический;
DEALLOCATE динамический;

-- Удаляем тестовый заказ
DELETE FROM Заказы WHERE Номер_заказа = '999';
PRINT N'Тестовый заказ удален';

PRINT N'=== ВЫВОД ===';
PRINT N'Статический курсор: показывает данные на момент открытия (' + CAST(@статическое_после AS nvarchar(10)) + ')';
PRINT N'Динамический курсор: показывает актуальные данные (' + CAST(@динамическое_после AS nvarchar(10)) + ')';
PRINT N'Фактическое количество: ' + CAST(@фактическое_количество AS nvarchar(10));
PRINT N'Разница: ' + CAST(@динамическое_после - @статическое_после AS nvarchar(10)) + N' заказ';